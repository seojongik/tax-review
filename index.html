<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê¸‰ì—¬ ê³µì œ ì…ë ¥</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:24px 32px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}
    .header h1{font-size:24px;font-weight:700}
    .header .subtitle{opacity:.9;margin-top:4px;font-size:14px}
    .header-info{display:flex;gap:24px;align-items:center;flex-wrap:wrap}
    .header-info .info-item{text-align:right}
    .header-info .info-item label{font-size:11px;opacity:.8;display:block}
    .header-info .info-item span{font-size:14px;font-weight:600}
    .btn{padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-primary{background:#fff;color:#667eea}
    .btn-primary:hover{background:#f0f0f0}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed}
    .btn-success{background:#10b981;color:#fff}
    .btn-success:hover{background:#059669}
    .card{background:#fff;border-radius:0 0 16px 16px;box-shadow:0 4px 20px rgba(0,0,0,.08);overflow:hidden}
    .message{padding:16px 24px;text-align:center;font-weight:500}
    .message.success{background:#d1fae5;color:#065f46}
    .message.error{background:#fee2e2;color:#991b1b}
    .message.warning{background:#fef3c7;color:#92400e}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #e5e7eb;overflow:hidden;text-overflow:ellipsis}
    th{background:#f8f9fa;font-weight:600;font-size:13px;color:#374151;position:sticky;top:0}
    td{font-size:14px}
    tr:hover{background:#f8f9fa}
    tr.completed{background:#f0fdf4}
    tr.completed input{background:#e5e7eb}
    .col-name{width:140px}
    .col-contract{width:90px}
    .col-salary{width:130px}
    .col-input{width:130px}
    .col-sum{width:110px}
    .col-net{width:130px}
    .col-status{width:90px}
    .name-cell{font-weight:600;display:flex;align-items:center;gap:8px}
    .type-badge{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:500;white-space:nowrap}
    .type-badge.pro{background:#dbeafe;color:#1d4ed8}
    .type-badge.manager{background:#fef3c7;color:#92400e}
    .amount{text-align:right;font-family:'SF Mono',monospace;white-space:nowrap}
    .deduction-input{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;text-align:right;transition:border-color .2s}
    .deduction-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .deduction-input:read-only{background:#f3f4f6;cursor:not-allowed}
    .deduction-sum{color:#dc2626;font-weight:600}
    .net-salary{color:#059669;font-weight:700;font-size:15px}
    .status-badge{font-size:12px;padding:4px 10px;border-radius:20px;background:#e5e7eb;color:#4b5563;white-space:nowrap}
    .status-badge.done{background:#dbeafe;color:#1d4ed8}
    .status-badge.paid{background:#d1fae5;color:#065f46}
    .summary-bar{display:flex;justify-content:space-between;gap:32px;padding:16px 24px;background:#f8f9fa;border-top:2px solid #e5e7eb;flex-wrap:wrap}
    .summary-left{display:flex;gap:16px;align-items:center}
    .summary-right{display:flex;gap:32px}
    .summary-item{text-align:right}
    .summary-item label{font-size:12px;color:#6b7280;display:block}
    .summary-item span{font-size:18px;font-weight:700}
    .summary-item.total span{color:#1f2937}
    .summary-item.deduction span{color:#dc2626}
    .summary-item.net span{color:#059669}
    .loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:16px}
    .loading.hide{display:none}
    .spinner{width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty-state{text-align:center;padding:60px 20px;color:#6b7280}
    .empty-state .icon{font-size:48px;margin-bottom:16px}
    .error-state{text-align:center;padding:60px 20px}
    .error-state .icon{font-size:48px;margin-bottom:16px}
    .error-state h2{color:#dc2626;margin-bottom:8px}
    .error-state p{color:#6b7280}
    .readonly-notice{background:#fef3c7;color:#92400e;padding:12px 24px;display:flex;align-items:center;gap:8px;font-size:14px}
    .readonly-notice .icon{font-size:18px}
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
  
  <div class="container" id="mainContent" style="display:none">
    <div class="header">
      <div>
        <h1 id="pageTitle">ê¸‰ì—¬ ê³µì œ ì…ë ¥</h1>
        <div class="subtitle" id="pageSubtitle">ì„¸ë¬´ì‚¬ë‹˜ê»˜ì„œ ê° ì§ì›ì˜ ê³µì œ ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
      </div>
      <div class="header-info">
        <div class="info-item" id="taxOfficeInfo" style="display:none">
          <label>ì„¸ë¬´ì‚¬</label>
          <span id="taxOfficeName">-</span>
        </div>
        <button class="btn btn-primary" id="saveAllBtn" onclick="saveAll()">ì „ì²´ ì €ì¥</button>
      </div>
    </div>
    <div class="card">
      <div id="noticeArea"></div>
      <div id="messageArea"></div>
      <div id="contentArea"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://yejialakeivdhwntmagf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllamlhbGFrZWl2ZGh3bnRtYWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MTE0MjcsImV4cCI6MjA3OTQ4NzQyN30.a1WA6V7pD2tss1pkh1OSJcuknt6FTyeabvm9UzNjcfs';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const params = new URLSearchParams(window.location.search);
    const branchId = params.get('branch');
    const year = parseInt(params.get('year')) || new Date().getFullYear();
    const month = parseInt(params.get('month')) || (new Date().getMonth() + 1);
    const token = params.get('token');
    
    let allEmployees = [];
    let submissionInfo = null;
    let isReadOnly = false;
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ko-KR').format(amount || 0) + 'ì›';
    }
    
    function showError(message) {
      document.getElementById('loading').classList.add('hide');
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('contentArea').innerHTML = `
        <div class="error-state">
          <div class="icon">âŒ</div>
          <h2>ì˜¤ë¥˜</h2>
          <p>${message}</p>
        </div>
      `;
    }
    
    async function loadData() {
      if (!token) {
        showError('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. (í† í° í•„ìš”)');
        return;
      }
      if (!branchId) {
        showError('ì§€ì  ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. (?branch=xxx)');
        return;
      }
      
      try {
        // 1. ë°œì†¡ ì •ë³´ í™•ì¸ (í† í° ê²€ì¦)
        const { data: submissionData, error: submissionError } = await db
          .from('v2_salary_tax_submission')
          .select('*')
          .eq('branch_id', branchId)
          .eq('year', year)
          .eq('month', month)
          .single();
        
        if (submissionError && submissionError.code !== 'PGRST116') {
          console.error('Submission Error:', submissionError);
        }
        
        submissionInfo = submissionData;
        
        // í† í° ê²€ì¦ (ë°œì†¡ ì •ë³´ê°€ ìˆê³  í† í°ì´ ì¼ì¹˜í•˜ëŠ”ì§€)
        if (submissionInfo && submissionInfo.submission_token && submissionInfo.submission_token !== token) {
          showError('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.');
          return;
        }
        
        // ì´ë¯¸ í™•ì •ëœ ê²½ìš° ì½ê¸° ì „ìš©
        if (submissionInfo && submissionInfo.submission_status === 'í™•ì •') {
          isReadOnly = true;
        }
        
        // 2. ê¸‰ì—¬ ë°ì´í„° ë¡œë“œ
        const { data: proData, error: proError } = await db
          .from('v2_salary_pro')
          .select('*')
          .eq('branch_id', branchId)
          .eq('year', year)
          .eq('month', month)
          .order('pro_name');
        
        const { data: managerData, error: managerError } = await db
          .from('v2_salary_manager')
          .select('*')
          .eq('branch_id', branchId)
          .eq('year', year)
          .eq('month', month)
          .order('manager_name');
        
        if (proError || managerError) {
          console.error('Pro Error:', proError);
          console.error('Manager Error:', managerError);
          throw new Error('ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
        }
        
        allEmployees = [
          ...(proData || []).map(e => ({...e, _type: 'pro', _name: e.pro_name})),
          ...(managerData || []).map(e => ({...e, _type: 'manager', _name: e.manager_name}))
        ];
        
        renderTable();
        
      } catch (error) {
        console.error(error);
        showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    function renderTable() {
      document.getElementById('loading').classList.add('hide');
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('pageTitle').textContent = `${year}ë…„ ${month}ì›” ê¸‰ì—¬ ê³µì œ ì…ë ¥`;
      
      // ì„¸ë¬´ì‚¬ ì •ë³´ í‘œì‹œ
      if (submissionInfo && submissionInfo.tax_office) {
        document.getElementById('taxOfficeInfo').style.display = 'block';
        document.getElementById('taxOfficeName').textContent = submissionInfo.tax_office;
      }
      
      // ì½ê¸° ì „ìš© ì•ˆë‚´
      if (isReadOnly) {
        document.getElementById('noticeArea').innerHTML = `
          <div class="readonly-notice">
            <span class="icon">ğŸ”’</span>
            ì´ë¯¸ í™•ì •ëœ ê¸‰ì—¬ì…ë‹ˆë‹¤. ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
          </div>
        `;
        document.getElementById('saveAllBtn').style.display = 'none';
        document.getElementById('pageSubtitle').textContent = 'í™•ì •ëœ ê¸‰ì—¬ ë‚´ì—­ì…ë‹ˆë‹¤';
      }
      
      if (allEmployees.length === 0) {
        document.getElementById('contentArea').innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“‹</div>
            <p>í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }
      
      const rows = allEmployees.map((emp, idx) => {
        const isFreelancer = emp.contract_type === 'í”„ë¦¬ëœì„œ';
        const type = emp._type === 'pro' ? 'ê°•ì‚¬' : 'ë§¤ë‹ˆì €';
        const totalSalary = emp.salary_total || 0;
        
        let currentDeduction = 0;
        if (isFreelancer) {
          currentDeduction = (emp.business_income_tax || 0) + (emp.local_tax || 0);
        } else {
          currentDeduction = (emp.four_insure || 0) + (emp.income_tax || 0);
        }
        currentDeduction += (emp.other_deduction || 0);
        const netSalary = totalSalary - currentDeduction;
        
        const isCompleted = emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ';
        const rowClass = isCompleted ? 'completed' : '';
        const readonlyAttr = (isReadOnly || isCompleted) ? 'readonly' : '';
        
        const field1 = isFreelancer ? 'business_income_tax' : 'four_insure';
        const field2 = isFreelancer ? 'local_tax' : 'income_tax';
        const val1 = emp[field1] || 0;
        const val2 = emp[field2] || 0;
        
        return `
          <tr class="${rowClass}" data-idx="${idx}" data-freelancer="${isFreelancer}">
            <td class="col-name">
              <div class="name-cell">
                <span class="type-badge ${emp._type}">${type}</span>
                ${emp._name}
              </div>
            </td>
            <td class="col-contract">${emp.contract_type || '-'}</td>
            <td class="col-salary amount">${formatCurrency(totalSalary)}</td>
            <td class="col-input"><input type="number" data-field="${field1}" value="${val1}" ${readonlyAttr} class="deduction-input" oninput="updateRow(${idx})"></td>
            <td class="col-input"><input type="number" data-field="${field2}" value="${val2}" ${readonlyAttr} class="deduction-input" oninput="updateRow(${idx})"></td>
            <td class="col-input"><input type="number" data-field="other_deduction" value="${emp.other_deduction || 0}" ${readonlyAttr} class="deduction-input" oninput="updateRow(${idx})"></td>
            <td class="col-sum amount deduction-sum" id="deduction-${idx}">${formatCurrency(currentDeduction)}</td>
            <td class="col-net amount net-salary" id="net-${idx}">${formatCurrency(netSalary)}</td>
            <td class="col-status">
              <span class="status-badge ${emp.salary_status === 'ì„¸ë¬´ê²€í† ì™„ë£Œ' ? 'done' : emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ' ? 'paid' : ''}">
                ${emp.salary_status || 'ëŒ€ê¸°'}
              </span>
            </td>
          </tr>
        `;
      }).join('');
      
      document.getElementById('contentArea').innerHTML = `
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th class="col-name">ì´ë¦„</th>
                <th class="col-contract">ê³„ì•½í˜•íƒœ</th>
                <th class="col-salary" style="text-align:right">ì´ê¸‰ì—¬</th>
                <th class="col-input">4ëŒ€ë³´í—˜/ì‚¬ì—…ì†Œë“ì„¸</th>
                <th class="col-input">ì†Œë“ì„¸/ì§€ë°©ì†Œë“ì„¸</th>
                <th class="col-input">ê¸°íƒ€ê³µì œ</th>
                <th class="col-sum" style="text-align:right">ê³µì œí•©ê³„</th>
                <th class="col-net" style="text-align:right">ì‹¤ìˆ˜ë ¹ì•¡</th>
                <th class="col-status">ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="employeeTable">${rows}</tbody>
          </table>
        </div>
        <div class="summary-bar">
          <div class="summary-left">
            ${!isReadOnly ? '<button class="btn btn-success" onclick="completeReview()">ê²€í†  ì™„ë£Œ</button>' : ''}
          </div>
          <div class="summary-right">
            <div class="summary-item total"><label>ì´ ê¸‰ì—¬ í•©ê³„</label><span id="summaryTotal">0ì›</span></div>
            <div class="summary-item deduction"><label>ì´ ê³µì œ í•©ê³„</label><span id="summaryDeduction">0ì›</span></div>
            <div class="summary-item net"><label>ì´ ì‹¤ìˆ˜ë ¹ì•¡</label><span id="summaryNet">0ì›</span></div>
          </div>
        </div>
      `;
      
      updateSummary();
    }
    
    function updateRow(idx) {
      const emp = allEmployees[idx];
      const row = document.querySelector(`tr[data-idx="${idx}"]`);
      const totalSalary = emp.salary_total || 0;
      
      const inputs = row.querySelectorAll('.deduction-input');
      let deduction = 0;
      inputs.forEach(input => {
        deduction += parseInt(input.value || 0);
      });
      
      document.getElementById(`deduction-${idx}`).textContent = formatCurrency(deduction);
      document.getElementById(`net-${idx}`).textContent = formatCurrency(totalSalary - deduction);
      
      updateSummary();
    }
    
    function updateSummary() {
      let totalSalary = 0;
      let totalDeduction = 0;
      
      allEmployees.forEach((emp, idx) => {
        const row = document.querySelector(`tr[data-idx="${idx}"]`);
        if (!row) return;
        
        const salary = emp.salary_total || 0;
        const inputs = row.querySelectorAll('.deduction-input');
        let deduction = 0;
        inputs.forEach(input => {
          deduction += parseInt(input.value || 0);
        });
        
        totalSalary += salary;
        totalDeduction += deduction;
      });
      
      document.getElementById('summaryTotal').textContent = formatCurrency(totalSalary);
      document.getElementById('summaryDeduction').textContent = formatCurrency(totalDeduction);
      document.getElementById('summaryNet').textContent = formatCurrency(totalSalary - totalDeduction);
    }
    
    async function saveAll() {
      if (isReadOnly) return;
      
      const btn = document.getElementById('saveAllBtn');
      btn.disabled = true;
      btn.textContent = 'ì €ì¥ ì¤‘...';
      
      try {
        for (let idx = 0; idx < allEmployees.length; idx++) {
          const emp = allEmployees[idx];
          const row = document.querySelector(`tr[data-idx="${idx}"]`);
          if (!row || emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ') continue;
          
          const isFreelancer = row.dataset.freelancer === 'true';
          const totalSalary = emp.salary_total || 0;
          
          const field1 = isFreelancer ? 'business_income_tax' : 'four_insure';
          const field2 = isFreelancer ? 'local_tax' : 'income_tax';
          
          const val1 = parseInt(row.querySelector(`[data-field="${field1}"]`)?.value || 0);
          const val2 = parseInt(row.querySelector(`[data-field="${field2}"]`)?.value || 0);
          const otherDeduction = parseInt(row.querySelector('[data-field="other_deduction"]')?.value || 0);
          
          const updateData = {
            [field1]: val1,
            [field2]: val2,
            other_deduction: otherDeduction,
            deduction_sum: val1 + val2 + otherDeduction,
          };
          updateData.salary_net = totalSalary - updateData.deduction_sum;
          
          const tableName = emp._type === 'pro' ? 'v2_salary_pro' : 'v2_salary_manager';
          await db.from(tableName).update(updateData).eq('id', emp.id);
        }
        
        document.getElementById('messageArea').innerHTML = '<div class="message success">âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
        setTimeout(() => {
          document.getElementById('messageArea').innerHTML = '';
        }, 3000);
        
        btn.disabled = false;
        btn.textContent = 'ì „ì²´ ì €ì¥';
        
      } catch (error) {
        console.error(error);
        document.getElementById('messageArea').innerHTML = '<div class="message error">ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        btn.disabled = false;
        btn.textContent = 'ì „ì²´ ì €ì¥';
      }
    }
    
    async function completeReview() {
      if (isReadOnly) return;
      
      if (!confirm('ê²€í† ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì™„ë£Œ í›„ì—ëŠ” ë‹´ë‹¹ìì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.')) {
        return;
      }
      
      try {
        // ë¨¼ì € ì €ì¥
        await saveAll();
        
        // ëª¨ë“  ì§ì› ìƒíƒœë¥¼ ì„¸ë¬´ê²€í† ì™„ë£Œë¡œ ë³€ê²½
        for (let idx = 0; idx < allEmployees.length; idx++) {
          const emp = allEmployees[idx];
          if (emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ') continue;
          
          const tableName = emp._type === 'pro' ? 'v2_salary_pro' : 'v2_salary_manager';
          await db.from(tableName).update({ salary_status: 'ì„¸ë¬´ê²€í† ì™„ë£Œ' }).eq('id', emp.id);
        }
        
        // ë°œì†¡ ì •ë³´ ì—…ë°ì´íŠ¸
        if (submissionInfo) {
          await db.from('v2_salary_tax_submission').update({
            submission_status: 'ê²€í† ì™„ë£Œ',
            reviewed_at: new Date().toISOString()
          }).eq('id', submissionInfo.id);
        }
        
        document.getElementById('messageArea').innerHTML = '<div class="message success">âœ… ê²€í† ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë‹´ë‹¹ìì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</div>';
        
        setTimeout(() => location.reload(), 2000);
        
      } catch (error) {
        console.error(error);
        document.getElementById('messageArea').innerHTML = '<div class="message error">ê²€í†  ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    loadData();
  </script>
</body>
</html>