<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¸ë¬´ì‚¬ ê¸‰ì—¬ ê²€í† </title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;min-height:100vh}
    
    /* ë ˆì´ì•„ì›ƒ */
    .layout{display:flex;min-height:100vh}
    .sidebar{width:280px;background:#1e293b;color:#fff;padding:20px;flex-shrink:0;display:flex;flex-direction:column}
    .main{flex:1;padding:24px;overflow-x:auto}
    
    /* ì‚¬ì´ë“œë°” */
    .sidebar-header{margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(255,255,255,.1)}
    .sidebar-header h1{font-size:18px;font-weight:700;margin-bottom:4px}
    .sidebar-header .subtitle{font-size:12px;opacity:.7}
    .tax-office-name{font-size:14px;color:#60a5fa;margin-top:8px}
    .tax-office-email{font-size:12px;opacity:.6;margin-top:2px}
    
    .nav-section{margin-bottom:24px}
    .nav-section-title{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:.5;margin-bottom:12px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;cursor:pointer;transition:all .2s;margin-bottom:4px}
    .nav-item:hover{background:rgba(255,255,255,.1)}
    .nav-item.active{background:#667eea;color:#fff}
    .nav-item .icon{width:20px;text-align:center}
    .nav-item .label{flex:1;font-size:14px}
    .nav-item .badge{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:10px;font-size:11px}
    .nav-item.active .badge{background:rgba(255,255,255,.3)}
    
    .month-selector{margin-top:auto;padding-top:16px;border-top:1px solid rgba(255,255,255,.1)}
    .month-selector label{font-size:12px;opacity:.7;display:block;margin-bottom:8px}
    .month-selector select{width:100%;padding:10px 12px;border-radius:6px;border:none;background:#334155;color:#fff;font-size:14px}
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .page-header{margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}
    .page-header h2{font-size:24px;font-weight:700;color:#1e293b}
    .page-header .actions{display:flex;gap:12px}
    
    .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:#667eea;color:#fff}
    .btn-primary:hover{background:#5a67d8}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed}
    .btn-success{background:#10b981;color:#fff}
    .btn-success:hover{background:#059669}
    .btn-outline{background:#fff;color:#374151;border:1px solid #d1d5db}
    .btn-outline:hover{background:#f9fafb}
    
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1);overflow:hidden;margin-bottom:24px}
    .card-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .card-header h3{font-size:16px;font-weight:600;color:#1e293b}
    .card-body{padding:20px}
    
    .message{padding:12px 20px;font-weight:500;display:flex;align-items:center;gap:8px}
    .message.success{background:#d1fae5;color:#065f46}
    .message.error{background:#fee2e2;color:#991b1b}
    .message.warning{background:#fef3c7;color:#92400e}
    .message.info{background:#dbeafe;color:#1e40af}
    
    /* í…Œì´ë¸” */
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #e5e7eb}
    th{background:#f8fafc;font-weight:600;font-size:13px;color:#64748b}
    td{font-size:14px;color:#1e293b}
    tr:hover{background:#f8fafc}
    tr.completed{background:#f0fdf4}
    
    .name-cell{font-weight:600;display:flex;align-items:center;gap:8px}
    .type-badge{font-size:11px;padding:2px 8px;border-radius:4px;font-weight:500}
    .type-badge.pro{background:#dbeafe;color:#1d4ed8}
    .type-badge.manager{background:#fef3c7;color:#92400e}
    
    .amount{text-align:right;font-family:'SF Mono',Consolas,monospace}
    .deduction-input{width:100%;max-width:120px;padding:8px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:14px;text-align:right}
    .deduction-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    .deduction-input:read-only{background:#f3f4f6;cursor:not-allowed}
    
    .deduction-sum{color:#dc2626;font-weight:600}
    .net-salary{color:#059669;font-weight:700}
    
    .status-badge{font-size:12px;padding:4px 10px;border-radius:20px;font-weight:500}
    .status-badge.waiting{background:#e5e7eb;color:#4b5563}
    .status-badge.sent{background:#fef3c7;color:#92400e}
    .status-badge.reviewing{background:#dbeafe;color:#1d4ed8}
    .status-badge.done{background:#d1fae5;color:#065f46}
    .status-badge.paid{background:#c7d2fe;color:#4338ca}
    
    /* ìš”ì•½ ë°” */
    .summary-bar{display:flex;justify-content:space-between;padding:16px 20px;background:#f8fafc;border-top:1px solid #e5e7eb;flex-wrap:wrap;gap:16px}
    .summary-left{display:flex;gap:12px;align-items:center}
    .summary-right{display:flex;gap:24px}
    .summary-item{text-align:right}
    .summary-item label{font-size:12px;color:#64748b;display:block;margin-bottom:2px}
    .summary-item span{font-size:18px;font-weight:700}
    .summary-item.total span{color:#1e293b}
    .summary-item.deduction span{color:#dc2626}
    .summary-item.net span{color:#059669}
    
    /* íˆìŠ¤í† ë¦¬ */
    .history-list{display:flex;flex-direction:column;gap:12px}
    .history-item{display:flex;align-items:center;gap:16px;padding:12px;background:#f8fafc;border-radius:8px;cursor:pointer;transition:background .2s}
    .history-item:hover{background:#e2e8f0}
    .history-item .month{font-weight:600;min-width:100px}
    .history-item .status{flex:1}
    .history-item .date{font-size:13px;color:#64748b}
    
    /* ë¡œë”© & ì—ëŸ¬ */
    .loading{display:flex;align-items:center;justify-content:center;padding:60px;flex-direction:column;gap:16px}
    .spinner{width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .empty-state{text-align:center;padding:60px 20px;color:#64748b}
    .empty-state .icon{font-size:48px;margin-bottom:16px}
    
    .error-page{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px;padding:20px}
    .error-page .icon{font-size:64px}
    .error-page h2{font-size:24px;color:#dc2626}
    .error-page p{color:#64748b}
    
    /* ë°˜ì‘í˜• */
    @media(max-width:768px){
      .layout{flex-direction:column}
      .sidebar{width:100%;padding:16px}
      .main{padding:16px}
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    const SUPABASE_URL = 'https://yejialakeivdhwntmagf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllamlhbGFrZWl2ZGh3bnRtYWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MTE0MjcsImV4cCI6MjA3OTQ4NzQyN30.a1WA6V7pD2tss1pkh1OSJcuknt6FTyeabvm9UzNjcfs';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // URL íŒŒë¼ë¯¸í„°
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const initialBranch = params.get('branch');
    const initialYear = parseInt(params.get('year')) || new Date().getFullYear();
    const initialMonth = parseInt(params.get('month')) || new Date().getMonth() + 1;
    
    // ìƒíƒœ
    let state = {
      taxOffice: null,
      taxEmail: null,
      branches: [],           // ì´ ì„¸ë¬´ì‚¬ê°€ ê´€ë¦¬í•˜ëŠ” ì§€ì  ëª©ë¡
      submissions: [],        // ë°œì†¡ ì´ë ¥
      selectedBranch: initialBranch,
      selectedYear: initialYear,
      selectedMonth: initialMonth,
      employees: [],
      loading: true,
      error: null,
      view: 'salary'          // salary | history
    };
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ko-KR').format(amount || 0) + 'ì›';
    }
    
    function getStatusBadge(status) {
      const map = {
        'ëŒ€ê¸°': { class: 'waiting', label: 'ëŒ€ê¸°' },
        'ë°œì†¡ì™„ë£Œ': { class: 'sent', label: 'ë°œì†¡ì™„ë£Œ' },
        'ì„¸ë¬´ì‚¬ê²€í† ': { class: 'reviewing', label: 'ê²€í† ì¤‘' },
        'ê²€í† ì™„ë£Œ': { class: 'done', label: 'ê²€í† ì™„ë£Œ' },
        'ì„¸ë¬´ê²€í† ì™„ë£Œ': { class: 'done', label: 'ê²€í† ì™„ë£Œ' },
        'í™•ì •': { class: 'paid', label: 'í™•ì •' },
        'ì§€ê¸‰ì™„ë£Œ': { class: 'paid', label: 'ì§€ê¸‰ì™„ë£Œ' },
        'ì‘ì—…ì¤‘': { class: 'waiting', label: 'ì‘ì—…ì¤‘' },
        'ì œì¶œì™„ë£Œ': { class: 'sent', label: 'ì œì¶œì™„ë£Œ' }
      };
      const info = map[status] || { class: 'waiting', label: status || 'ëŒ€ê¸°' };
      return `<span class="status-badge ${info.class}">${info.label}</span>`;
    }
    
    // ì´ˆê¸° ë¡œë”©
    async function init() {
      if (!token) {
        showError('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. (í† í° í•„ìš”)');
        return;
      }
      
      try {
        // 1. í† í°ìœ¼ë¡œ ì„¸ë¬´ì‚¬ ì •ë³´ ì¡°íšŒ (í† í° = submission_token)
        let submissions = [];
        
        // ë¨¼ì € í† í°ìœ¼ë¡œ ì§ì ‘ ì¡°íšŒ
        const { data: tokenData } = await db
          .from('v2_salary_tax_submission')
          .select('*')
          .eq('submission_token', token);
        
        if (tokenData && tokenData.length > 0) {
          // í† í°ì—ì„œ ì´ë©”ì¼ ì¶”ì¶œ
          const email = tokenData[0].tax_office_email;
          
          if (email) {
            // ê°™ì€ ì´ë©”ì¼ì˜ ëª¨ë“  ë°œì†¡ ì •ë³´ ì¡°íšŒ (ì—¬ëŸ¬ ì§€ì  í†µí•©)
            const { data: emailData } = await db
              .from('v2_salary_tax_submission')
              .select('*')
              .eq('tax_office_email', email)
              .order('year', { ascending: false })
              .order('month', { ascending: false });
            
            submissions = emailData || tokenData;
          } else {
            submissions = tokenData;
          }
        }
        
        if (!submissions || submissions.length === 0) {
          // ë‹¨ì¼ ì§€ì  ëª¨ë“œ (ê¸°ì¡´ ë°©ì‹ í˜¸í™˜)
          if (initialBranch) {
            state.selectedBranch = initialBranch;
            state.taxOffice = 'ì„¸ë¬´ì‚¬';
            state.branches = [{ branch_id: initialBranch, branch_name: initialBranch }];
          } else {
            showError('ë“±ë¡ëœ ë°œì†¡ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
        } else {
          state.submissions = submissions;
          state.taxOffice = submissions[0].tax_office || 'ì„¸ë¬´ì‚¬';
          state.taxEmail = submissions[0].tax_office_email || '';
          
          // ê³ ìœ  ì§€ì  ëª©ë¡ ì¶”ì¶œ
          const branchMap = new Map();
          submissions.forEach(s => {
            if (!branchMap.has(s.branch_id)) {
              branchMap.set(s.branch_id, { branch_id: s.branch_id, branch_name: s.branch_id });
            }
          });
          state.branches = Array.from(branchMap.values());
          
          // ì²« ë²ˆì§¸ ì§€ì  ì„ íƒ
          if (!state.selectedBranch && state.branches.length > 0) {
            state.selectedBranch = state.branches[0].branch_id;
          }
        }
        
        // ì§€ì ëª… ì¡°íšŒ
        await loadBranchNames();
        
        // ê¸‰ì—¬ ë°ì´í„° ë¡œë“œ
        await loadSalaryData();
        
      } catch (err) {
        console.error(err);
        showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function loadBranchNames() {
      try {
        const branchIds = state.branches.map(b => b.branch_id);
        const { data } = await db
          .from('v2_branch')
          .select('branch_id, branch_name')
          .in('branch_id', branchIds);
        
        if (data) {
          const nameMap = new Map(data.map(b => [b.branch_id, b.branch_name]));
          state.branches = state.branches.map(b => ({
            ...b,
            branch_name: nameMap.get(b.branch_id) || b.branch_id
          }));
        }
      } catch (e) {
        console.log('ì§€ì ëª… ì¡°íšŒ ì‹¤íŒ¨:', e);
      }
    }
    
    async function loadSalaryData() {
      if (!state.selectedBranch) {
        state.employees = [];
        render();
        return;
      }
      
      state.loading = true;
      render();
      
      try {
        const { data: proData } = await db
          .from('v2_salary_pro')
          .select('*')
          .eq('branch_id', state.selectedBranch)
          .eq('year', state.selectedYear)
          .eq('month', state.selectedMonth)
          .order('pro_name');
        
        const { data: managerData } = await db
          .from('v2_salary_manager')
          .select('*')
          .eq('branch_id', state.selectedBranch)
          .eq('year', state.selectedYear)
          .eq('month', state.selectedMonth)
          .order('manager_name');
        
        state.employees = [
          ...(proData || []).map(e => ({...e, _type: 'pro', _name: e.pro_name})),
          ...(managerData || []).map(e => ({...e, _type: 'manager', _name: e.manager_name}))
        ];
        
        state.loading = false;
        render();
        
      } catch (err) {
        console.error(err);
        state.loading = false;
        state.error = 'ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨';
        render();
      }
    }
    
    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div class="error-page">
          <div class="icon">âŒ</div>
          <h2>ì˜¤ë¥˜</h2>
          <p>${message}</p>
        </div>
      `;
    }
    
    function render() {
      const currentSubmission = state.submissions.find(s => 
        s.branch_id === state.selectedBranch && 
        s.year === state.selectedYear && 
        s.month == state.selectedMonth
      );
      const isReadOnly = currentSubmission?.submission_status === 'í™•ì •';
      
      // í•´ë‹¹ ì§€ì ì˜ ì›”ë³„ ì´ë ¥
      const branchHistory = state.submissions
        .filter(s => s.branch_id === state.selectedBranch)
        .slice(0, 12);
      
      document.getElementById('app').innerHTML = `
        <div class="layout">
          <div class="sidebar">
            <div class="sidebar-header">
              <h1>ê¸‰ì—¬ ê²€í†  ì‹œìŠ¤í…œ</h1>
              <div class="subtitle">Tax Review Portal</div>
              <div class="tax-office-name">ğŸ¢ ${state.taxOffice}</div>
              ${state.taxEmail ? `<div class="tax-office-email">ğŸ“§ ${state.taxEmail}</div>` : ''}
            </div>
            
            <div class="nav-section">
              <div class="nav-section-title">ì§€ì  ì„ íƒ (${state.branches.length}ê°œ)</div>
              ${state.branches.map(b => `
                <div class="nav-item ${state.selectedBranch === b.branch_id ? 'active' : ''}" onclick="selectBranch('${b.branch_id}')">
                  <span class="icon">ğŸª</span>
                  <span class="label">${b.branch_name}</span>
                  ${getSubmissionBadge(b.branch_id)}
                </div>
              `).join('')}
            </div>
            
            <div class="nav-section">
              <div class="nav-section-title">ë©”ë‰´</div>
              <div class="nav-item ${state.view === 'salary' ? 'active' : ''}" onclick="setView('salary')">
                <span class="icon">ğŸ“‹</span>
                <span class="label">ê¸‰ì—¬ ê²€í† </span>
              </div>
              <div class="nav-item ${state.view === 'history' ? 'active' : ''}" onclick="setView('history')">
                <span class="icon">ğŸ“…</span>
                <span class="label">ì›”ë³„ ì´ë ¥</span>
              </div>
            </div>
            
            <div class="month-selector">
              <label>ê¸°ì¤€ ì›”</label>
              <select onchange="changeMonth(this.value)">
                ${generateMonthOptions()}
              </select>
            </div>
          </div>
          
          <div class="main">
            ${state.view === 'salary' ? renderSalaryView(currentSubmission, isReadOnly) : renderHistoryView(branchHistory)}
          </div>
        </div>
      `;
      
      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      if (state.view === 'salary') {
        bindInputEvents();
      }
    }
    
    function getSubmissionBadge(branchId) {
      const sub = state.submissions.find(s => 
        s.branch_id === branchId && 
        s.year === state.selectedYear && 
        s.month == state.selectedMonth
      );
      if (!sub) return '';
      
      const statusMap = {
        'ëŒ€ê¸°': 'â³',
        'ë°œì†¡ì™„ë£Œ': 'ğŸ“¤',
        'ê²€í† ì™„ë£Œ': 'âœ…',
        'í™•ì •': 'ğŸ”’'
      };
      return `<span class="badge">${statusMap[sub.submission_status] || ''}</span>`;
    }
    
    function generateMonthOptions() {
      const options = [];
      const now = new Date();
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const selected = (y === state.selectedYear && m === state.selectedMonth) ? 'selected' : '';
        options.push(`<option value="${y}-${m}" ${selected}>${y}ë…„ ${m}ì›”</option>`);
      }
      return options.join('');
    }
    
    function renderSalaryView(submission, isReadOnly) {
      const branchName = state.branches.find(b => b.branch_id === state.selectedBranch)?.branch_name || state.selectedBranch;
      
      if (state.loading) {
        return `
          <div class="loading">
            <div class="spinner"></div>
            <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        `;
      }
      
      if (state.employees.length === 0) {
        return `
          <div class="page-header">
            <h2>${branchName} - ${state.selectedYear}ë…„ ${state.selectedMonth}ì›”</h2>
          </div>
          <div class="card">
            <div class="empty-state">
              <div class="icon">ğŸ“‹</div>
              <p>í•´ë‹¹ ì›”ì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          </div>
        `;
      }
      
      const rows = state.employees.map((emp, idx) => {
        const isFreelancer = emp.contract_type === 'í”„ë¦¬ëœì„œ';
        const type = emp._type === 'pro' ? 'ê°•ì‚¬' : 'ë§¤ë‹ˆì €';
        const totalSalary = emp.salary_total || 0;
        
        let deduction = 0;
        if (isFreelancer) {
          deduction = (emp.business_income_tax || 0) + (emp.local_tax || 0);
        } else {
          deduction = (emp.four_insure || 0) + (emp.income_tax || 0);
        }
        deduction += (emp.other_deduction || 0);
        const netSalary = totalSalary - deduction;
        
        const field1 = isFreelancer ? 'business_income_tax' : 'four_insure';
        const field2 = isFreelancer ? 'local_tax' : 'income_tax';
        const readonlyAttr = (isReadOnly || emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ') ? 'readonly' : '';
        
        return `
          <tr data-idx="${idx}" data-freelancer="${isFreelancer}" class="${emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ' ? 'completed' : ''}">
            <td>
              <div class="name-cell">
                <span class="type-badge ${emp._type}">${type}</span>
                ${emp._name}
              </div>
            </td>
            <td>${emp.contract_type || '-'}</td>
            <td class="amount">${formatCurrency(totalSalary)}</td>
            <td><input type="number" class="deduction-input" data-field="${field1}" value="${emp[field1] || 0}" ${readonlyAttr}></td>
            <td><input type="number" class="deduction-input" data-field="${field2}" value="${emp[field2] || 0}" ${readonlyAttr}></td>
            <td><input type="number" class="deduction-input" data-field="other_deduction" value="${emp.other_deduction || 0}" ${readonlyAttr}></td>
            <td class="amount deduction-sum">${formatCurrency(deduction)}</td>
            <td class="amount net-salary">${formatCurrency(netSalary)}</td>
            <td>${getStatusBadge(emp.salary_status)}</td>
          </tr>
        `;
      }).join('');
      
      return `
        <div class="page-header">
          <h2>${branchName} - ${state.selectedYear}ë…„ ${state.selectedMonth}ì›”</h2>
          <div class="actions">
            ${!isReadOnly ? `
              <button class="btn btn-outline" onclick="saveAll()">ğŸ’¾ ì €ì¥</button>
              <button class="btn btn-success" onclick="completeReview()">âœ… ê²€í†  ì™„ë£Œ</button>
            ` : ''}
          </div>
        </div>
        
        ${isReadOnly ? `
          <div class="message warning">
            <span>ğŸ”’</span> ì´ë¯¸ í™•ì •ëœ ê¸‰ì—¬ì…ë‹ˆë‹¤. ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
          </div>
        ` : ''}
        
        <div id="messageArea"></div>
        
        <div class="card">
          <div style="overflow-x:auto">
            <table>
              <thead>
                <tr>
                  <th>ì´ë¦„</th>
                  <th>ê³„ì•½í˜•íƒœ</th>
                  <th class="amount">ì´ê¸‰ì—¬</th>
                  <th>4ëŒ€ë³´í—˜/ì‚¬ì—…ì†Œë“ì„¸</th>
                  <th>ì†Œë“ì„¸/ì§€ë°©ì†Œë“ì„¸</th>
                  <th>ê¸°íƒ€ê³µì œ</th>
                  <th class="amount">ê³µì œí•©ê³„</th>
                  <th class="amount">ì‹¤ìˆ˜ë ¹ì•¡</th>
                  <th>ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="employeeTable">${rows}</tbody>
            </table>
          </div>
          <div class="summary-bar">
            <div class="summary-left">
              ${submission ? `<span style="font-size:13px;color:#64748b">ë°œì†¡ì¼: ${submission.sent_at ? new Date(submission.sent_at).toLocaleDateString('ko-KR') : '-'}</span>` : ''}
            </div>
            <div class="summary-right">
              <div class="summary-item total"><label>ì´ ê¸‰ì—¬</label><span id="summaryTotal">0ì›</span></div>
              <div class="summary-item deduction"><label>ì´ ê³µì œ</label><span id="summaryDeduction">0ì›</span></div>
              <div class="summary-item net"><label>ì‹¤ìˆ˜ë ¹ì•¡</label><span id="summaryNet">0ì›</span></div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderHistoryView(history) {
      const branchName = state.branches.find(b => b.branch_id === state.selectedBranch)?.branch_name || state.selectedBranch;
      
      return `
        <div class="page-header">
          <h2>${branchName} - ì›”ë³„ ì´ë ¥</h2>
        </div>
        
        <div class="card">
          <div class="card-body">
            ${history.length === 0 ? `
              <div class="empty-state">
                <div class="icon">ğŸ“…</div>
                <p>ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            ` : `
              <div class="history-list">
                ${history.map(h => `
                  <div class="history-item" onclick="goToMonth(${h.year}, ${h.month})">
                    <div class="month">${h.year}ë…„ ${h.month}ì›”</div>
                    <div class="status">${getStatusBadge(h.submission_status)}</div>
                    <div class="date">
                      ${h.sent_at ? 'ë°œì†¡: ' + new Date(h.sent_at).toLocaleDateString('ko-KR') : ''}
                      ${h.reviewed_at ? ' | ê²€í† : ' + new Date(h.reviewed_at).toLocaleDateString('ko-KR') : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    function bindInputEvents() {
      document.querySelectorAll('.deduction-input').forEach(input => {
        input.addEventListener('input', updateCalculations);
      });
      updateCalculations();
    }
    
    function updateCalculations() {
      let totalSalary = 0;
      let totalDeduction = 0;
      
      document.querySelectorAll('#employeeTable tr').forEach((row, idx) => {
        const emp = state.employees[idx];
        if (!emp) return;
        
        const salary = emp.salary_total || 0;
        const inputs = row.querySelectorAll('.deduction-input');
        let deduction = 0;
        inputs.forEach(input => {
          deduction += parseInt(input.value || 0);
        });
        
        row.querySelector('.deduction-sum').textContent = formatCurrency(deduction);
        row.querySelector('.net-salary').textContent = formatCurrency(salary - deduction);
        
        totalSalary += salary;
        totalDeduction += deduction;
      });
      
      const summaryTotal = document.getElementById('summaryTotal');
      const summaryDeduction = document.getElementById('summaryDeduction');
      const summaryNet = document.getElementById('summaryNet');
      
      if (summaryTotal) summaryTotal.textContent = formatCurrency(totalSalary);
      if (summaryDeduction) summaryDeduction.textContent = formatCurrency(totalDeduction);
      if (summaryNet) summaryNet.textContent = formatCurrency(totalSalary - totalDeduction);
    }
    
    // ì•¡ì…˜ í•¨ìˆ˜ë“¤
    window.selectBranch = function(branchId) {
      state.selectedBranch = branchId;
      loadSalaryData();
    };
    
    window.setView = function(view) {
      state.view = view;
      render();
      if (view === 'salary') bindInputEvents();
    };
    
    window.changeMonth = function(value) {
      const [year, month] = value.split('-').map(Number);
      state.selectedYear = year;
      state.selectedMonth = month;
      loadSalaryData();
    };
    
    window.goToMonth = function(year, month) {
      state.selectedYear = year;
      state.selectedMonth = month;
      state.view = 'salary';
      loadSalaryData();
    };
    
    window.saveAll = async function() {
      const messageArea = document.getElementById('messageArea');
      
      try {
        for (let idx = 0; idx < state.employees.length; idx++) {
          const emp = state.employees[idx];
          const row = document.querySelector(`tr[data-idx="${idx}"]`);
          if (!row || emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ') continue;
          
          const isFreelancer = row.dataset.freelancer === 'true';
          const totalSalary = emp.salary_total || 0;
          
          const field1 = isFreelancer ? 'business_income_tax' : 'four_insure';
          const field2 = isFreelancer ? 'local_tax' : 'income_tax';
          
          const val1 = parseInt(row.querySelector(`[data-field="${field1}"]`)?.value || 0);
          const val2 = parseInt(row.querySelector(`[data-field="${field2}"]`)?.value || 0);
          const otherDeduction = parseInt(row.querySelector('[data-field="other_deduction"]')?.value || 0);
          
          const deductionSum = val1 + val2 + otherDeduction;
          
          const updateData = {
            [field1]: val1,
            [field2]: val2,
            other_deduction: otherDeduction,
            deduction_sum: deductionSum,
            salary_net: totalSalary - deductionSum
          };
          
          const tableName = emp._type === 'pro' ? 'v2_salary_pro' : 'v2_salary_manager';
          await db.from(tableName).update(updateData).eq('id', emp.id);
        }
        
        messageArea.innerHTML = '<div class="message success">âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
        setTimeout(() => { messageArea.innerHTML = ''; }, 3000);
        
      } catch (err) {
        console.error(err);
        messageArea.innerHTML = '<div class="message error">ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    };
    
    window.completeReview = async function() {
      if (!confirm('ê²€í† ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nì™„ë£Œ í›„ ë‹´ë‹¹ìì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.')) return;
      
      const messageArea = document.getElementById('messageArea');
      
      try {
        await saveAll();
        
        // ëª¨ë“  ì§ì› ìƒíƒœ ì—…ë°ì´íŠ¸
        for (const emp of state.employees) {
          if (emp.salary_status === 'ì§€ê¸‰ì™„ë£Œ') continue;
          const tableName = emp._type === 'pro' ? 'v2_salary_pro' : 'v2_salary_manager';
          await db.from(tableName).update({ salary_status: 'ì„¸ë¬´ê²€í† ì™„ë£Œ' }).eq('id', emp.id);
        }
        
        // ë°œì†¡ ì •ë³´ ì—…ë°ì´íŠ¸
        const submission = state.submissions.find(s => 
          s.branch_id === state.selectedBranch && 
          s.year === state.selectedYear && 
          s.month == state.selectedMonth
        );
        
        if (submission) {
          await db.from('v2_salary_tax_submission').update({
            submission_status: 'ê²€í† ì™„ë£Œ',
            reviewed_at: new Date().toISOString()
          }).eq('id', submission.id);
        }
        
        messageArea.innerHTML = '<div class="message success">âœ… ê²€í† ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
        setTimeout(() => location.reload(), 1500);
        
      } catch (err) {
        console.error(err);
        messageArea.innerHTML = '<div class="message error">ê²€í†  ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
      }
    };
    
    // ì‹œì‘
    init();
  </script>
</body>
</html>